extends layout

block css
  link(rel='stylesheet' href='/editor/css/medium-editor.css')
  link(rel='stylesheet' href='/editor/css/themes/default.css')

block content
  div.article-container
    article.article.detail-page.article-editor
      hgroup
        h3#title.editable.title(data-placeholder='标题', data-disable-toolbar='true', data-disable-return='true')
          != article ? article.title : ''
        h4#subtitle.editable.subtitle(data-placeholder='副标题', data-disable-toolbar='true', data-disable-return='true')
          != article ? article.subtitle : ''
      div#content.editable.content(data-placeholder='文章内容')
        != article ? article.content : ''
    ul.buttons
      li
        button#delete-btn.btn.btn-default(type='button') 删除
      li
        button#cancel-btn.btn.btn-default(type='button') 取消
      li
        button#save-btn.btn.btn-default(type='button') 保存
      li
        button#publish-btn.btn.btn-success(type='button') 发布

    form(action='/articles', method='post', name='article')
      input(type='hidden', name='title')
      input(type='hidden', name='subtitle')
      input(type='hidden', name='content')
      input(type='hidden', name='draft')
      input#article-id(type='hidden', name='articleId' value=article ? article._id : '')

  //.alert.alert-danger.alert-position 副标题太短

block script
  script(src='/editor/js/medium-editor.js')
  script.
    var editors = new MediumEditor('.editable');

    var articleId = '#{article ? article._id : ''}';

    // 点保存按钮时，给draft传的值
    var isDraft = #{article ? !!article.draft : true};

    var uid = '#{user._id}';

    var form = document.forms['article'];

    var editables = $('.editable');

    editables.get(0).focus();

      function save(isPublish) {
        var data = editors.serialize();
        var title = data.title.value.replace(/^<p>(.*)<\/p>/, '$1');
        var subtitle = data.subtitle.value.replace(/^<p>(.*)<\/p>/, '$1');
        var content = data.content.value;

        var url, method;

        title = title.trim();
        subtitle = subtitle.trim();
        content = content.trim();

        console.log(title);
        console.log(subtitle);
        console.log(content);

        if (!title) {
            AlertUtil.alert('danger', '标题不能为空');
            return;
        } else if (title.length > 30) {
            AlertUtil.alert('danger', '标题长度不能超过30个字');
            return;
        }

        if (subtitle.length > 60) {
            AlertUtil.alert('danger', '副标题不能超过60个字');
            return;
        }

        if (isPublish && !content) {
            AlertUtil.alert('danger', '文章内容不能为空');
            return;
        }

        /*var elements = form.elements;
        if (form) {
          elements['title'].value = title.trim();
          elements['subtitle'].value = subtitle;
          elements['content'].value = content;
          elements['draft'].value = isPublish ? 'false' : isDraft;
          form.submit();
        }*/

          var postData = {
              title: title,
              subtitle: subtitle,
              content: content,
              draft: isDraft,
              isPublish: isPublish
          }

          if (articleId) {
              url = '/articles/' + articleId;
              method = 'PUT';
          } else {
              url = '/articles';
              method = 'POST';
          }

          $.ajax({
              url: url,
              type: method,
              dataType: 'json',
              data: JSON.stringify(postData),
              contentType: 'application/json'
          }).done(function(data) {
              console.log(data);
              if (data.status == 'success') {
                  articleId = data.data._id.toString();
                  if (isPublish) {
                      window.location.href = '/article/' + data.data._id;
                  } else {
                      AlertUtil.alert('success', '保存成功');
                  }
              } else {
                  AlertUtil.alert('danger', data.message);
              }
          });
      }

    $('#publish-btn').click(function(e) {
        save(true);
    });

    $('#cancel-btn').click(function(e) {
        window.location.href = '/home/' + uid;
    });

    $('#save-btn').click(function(e) {
        save(false);
    });

    if (!articleId) {
        $('#delete-btn').hide();
    }

    $('#delete-btn').click(function(e) {
       $.ajax({
          type: "DELETE",
          url: "/article",
          data: { articleId: articleId }
       }).done(function( result ) {
          if (result.status == 'success') {
              window.location.href = '/home/' + uid;
          }
       });
    });

    //todo  for test, will remove.
    $('.editable').focus(function(e) {
        // setEndOfContenteditable(this);
    }).keydown(function(e) {
        console.log('keydown,' + 'which: ' + e.which);
        if (e.which == 229) {
            console.log('ime keydown');
        }
    }).keypress(function(e) {
        console.log('keypress');
    }).mousedown(function(e) {
        //e.preventDefault();
    }).click(function(e) {
        //e.preventDefault();
    }).keyup(function(e) {
        // e.preventDefault();
        console.log('keyup, which: ' + e.which);
    });

    function setEndOfContenteditable(contentEditableElement) {
          var range,selection;
          if(document.createRange) { //Firefox, Chrome, Opera, Safari, IE 9+
              range = document.createRange();//Create a range (a range is a like the selection but invisible)
              range.selectNodeContents(contentEditableElement);//Select the entire contents of the element with the range
              range.collapse(false);//collapse the range to the end point. false means collapse to end rather than the start
              selection = window.getSelection();//get the selection object (allows you to change selection)
              selection.removeAllRanges();//remove any selections already made
              selection.addRange(range);//make the range you have just created the visible selection
          } else if(document.selection) { //IE 8 and lower
              range = document.body.createTextRange();//Create a range (a range is a like the selection but invisible)
              range.moveToElementText(contentEditableElement);//Select the entire contents of the element with the range
              range.collapse(false);//collapse the range to the end point. false means collapse to end rather than the start
              range.select();//Select the range (make it the visible selection
          }
    }