extends layout

block content
  .main-container

    header.collection-header
      h2= collection.name
      div.intro= collection.intro
      div.follow-wrapper
        if collection.isFollowing
          button.btn.btn-lg.btn-success.follow-btn(data-collid=collection._id.toString()) 已订阅
        else
          button.btn.btn-lg.btn-default.follow-btn(data-collid=collection._id.toString()) 订阅

    section.article-list
        each article in collection.articles
            article.article
              header
                // <div class="collection"><a href="#">月过女墙</a></div>
                hgroup
                  h3.title
                    a(href='/article/#{article._id}') #{article.title}
                  h4.subtitle
                    a(href='/article/#{article._id}') #{article.subtitle}
                section.article-info
                  a.avatar(href='/home/#{article.author._id}')
                    img(src='#{article.author.avatar_s}', alt='作者')
                  a(href='/home/#{article.author._id}')= article.author.nickname
                  | 发表在
                  a(href='/collection/#{collection._id}', onclick='return false;')= collection.name

    ul.buttons
      li
        button#contribute.btn.btn-default(type='button') 投稿
      if user._id.str == collection.creator.str
        li
          button#edit-btn.btn.btn-success(type='button') 编辑

    div#choose-articles.choose-articles(style='display: none;')



block script
    script.
        var collId = '#{collection._id}';

        $('#edit-btn').click(function(e) {
            window.location.href = '/edit_collection/' + collId;
        });

        $('.follow-btn').click(function(e) {
            var button = $(this);
            var isFollowing = button.is('.btn-success');
            var collId = button.data('collid');
            var url;

            if (isFollowing) {
                url = '/coll_unsubscribe';
            } else {
                url = '/coll_subscribe';
            }

            $.ajax({
                url: url,
                data: {collId: collId}
            }).done(function(data) {
                if (data) {
                    if (data.status == 'success') {
                        if (data.data.isFollowing) {
                            button.removeClass('btn-default').addClass('btn-success').text('已订阅');
                        } else {
                            button.removeClass('btn-success').addClass('btn-default').text('订阅');
                        }
                    } else {
                        alert(data.message);
                    }
                } else {
                    alert('操作失败');
                }
            }).fail(function(data) {
                alert('操作失败');
            })
        });

        var articlesWrapper = $('#choose-articles');

        $('#contribute').on('click', function(e) {
            if (articlesWrapper.is(':visible'))
                return;

            $.ajax({
                url: '/myarticles',
                data: {
                    collId: collId
                }
            }).done(function(html) {
                articlesWrapper.html(html);
                articlesWrapper.slideDown();
            });
        });

        articlesWrapper.on('click', '.add-my-article', function(e) {
            e.preventDefault();
            var that = $(this);
            var item = that.closest('li');
            var articleId = item.data('id');
            if (item.is('.already-contributed')) {
                return;
            }
            $.ajax({
                url: '/contribute',
                data: {
                    articleId: articleId,
                    collId: collId
                }
            }).done(function(data) {
                if (data.status == 'success') {
                    item.addClass('already-contributed');
                } else {
                    alert(data.message);
                }
            });
        }).on('click', '.remove-article', function(e) {
            e.preventDefault();
            var that = $(this);
            var item = that.closest('li');
            var articleId = item.data('id');

            $.ajax({
                url: '/decontribute',
                data: {
                    articleId: articleId,
                    collId: collId
                }
            }).done(function(data) {
                if (data.status == 'success') {
                    item.removeClass('already-contributed');
                } else {
                    alert(data.message);
                }
            });
        });

        $(document).mouseup(function(e) {
            if (!articlesWrapper.is(e.target) && articlesWrapper.has(e.target).length === 0) {
                articlesWrapper.slideUp();
            }
        });
